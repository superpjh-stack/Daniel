# Noah's Ark: Logic Fit (노아의 방주 테트리스) Planning Document

> **Summary**: 게임 메뉴의 두 번째 게임으로, 노아의 방주에 동물 블록을 빈틈없이 배치하는 테트리스형 퍼즐 게임
>
> **Project**: 다니엘 - 동은교회 초등부 출석부
> **Author**: AI Assistant
> **Date**: 2026-02-16
> **Status**: Draft

---

## 1. Overview

### 1.1 Purpose

기존 `/games` 페이지의 두 번째 게임으로 "노아의 방주: Logic Fit"을 추가합니다. 노아의 방주라는 제한된 공간에 다양한 동물 쌍을 효율적으로 배치하는 테트리스형 퍼즐 게임입니다. 성경의 노아 방주 이야기를 게임 메커닉으로 자연스럽게 학습할 수 있도록 설계합니다.

### 1.2 Background

- 벽돌깨기(brick-breaker)에 이은 두 번째 성경 게임
- 테트리스 스타일의 블록 퍼즐은 초등부 아이들에게 직관적이고 친숙
- 방주의 무게 균형 물리 엔진으로 긴장감과 전략적 사고 촉진
- 스테이지 클리어 시 무지개 연출로 성경 스토리 전달 (창 9:13)

### 1.3 Related Documents

- 게임 목록 페이지: `src/app/(dashboard)/games/page.tsx`
- 벽돌깨기 게임 (참조): `src/app/(dashboard)/games/brick-breaker/`
- 달란트 시스템: `src/lib/db.ts` (Talent 모델)
- 기존 보상 API 패턴: `src/app/api/games/brick-breaker/reward/route.ts`

---

## 2. Scope

### 2.1 In Scope

- [ ] 게임 목록 페이지에 "노아의 방주" 카드 추가 (Coming Soon → 활성화)
- [ ] HTML5 Canvas 기반 테트리스형 퍼즐 게임 엔진
- [ ] 동물 블록 시스템 — 다양한 모양의 테트로미노 블록 + 동물 이미지
- [ ] 방주 무게 균형 물리 — 블록 배치에 따른 좌우 기울기 시스템
- [ ] 5개 스테이지 (비 → 비가 그치고 무지개) 진행 시스템
- [ ] 스테이지 클리어 시 무지개 연출 + 성경 구절 표시
- [ ] 퀴즈 블록 — 특수 블록 배치 시 노아 관련 성경 퀴즈 팝업
- [ ] 달란트 보상 연동 (기존 패턴 재사용)
- [ ] 모바일 터치 + 데스크톱 키보드/마우스 조작

### 2.2 Out of Scope

- 멀티플레이어 / 대전 모드
- 커스텀 블록 생성
- 동물 도감 / 컬렉션 시스템 (향후 확장 가능)
- 난이도 자유 선택 (스테이지 순차 진행만)

---

## 3. Requirements

### 3.1 Functional Requirements

| ID | Requirement | Priority | Status |
|----|-------------|----------|--------|
| FR-01 | 게임 목록 페이지에 "노아의 방주" 카드 추가 | High | Pending |
| FR-02 | Canvas 기반 테트리스형 블록 낙하 + 배치 엔진 | High | Pending |
| FR-03 | 7종 테트로미노 블록(I, O, T, S, Z, L, J) + 동물 스킨 | High | Pending |
| FR-04 | 블록 회전(시계/반시계), 이동(좌/우), 소프트/하드 드롭 | High | Pending |
| FR-05 | 완성된 가로줄 제거 + 점수 획득 | High | Pending |
| FR-06 | 방주 무게 균형 시스템 — 좌우 블록 무게 차이에 따른 기울기 | High | Pending |
| FR-07 | 기울기 임계값 초과 시 경고 → 게임 오버 | High | Pending |
| FR-08 | 5개 스테이지: 클리어 조건(목표 줄 수), 비 배경 연출 | Medium | Pending |
| FR-09 | 스테이지 클리어 시 무지개 애니메이션 + 성경 구절 표시 | Medium | Pending |
| FR-10 | 퀴즈 블록: 특정 블록 배치 시 노아/방주 관련 퀴즈 팝업 | Medium | Pending |
| FR-11 | 게임 완료 시 달란트 보상 (기존 패턴, 하루 3회 제한) | High | Pending |
| FR-12 | 게임 결과 화면 (점수, 줄 수, 보상, 다시하기) | High | Pending |
| FR-13 | 다음 블록 미리보기 (Next Block Preview) | Medium | Pending |
| FR-14 | 모바일: 스와이프 좌/우 이동, 위 스와이프 회전, 아래 스와이프 드롭 | High | Pending |
| FR-15 | 일시정지/재개 기능 | Medium | Pending |

### 3.2 Non-Functional Requirements

| Category | Criteria | Measurement Method |
|----------|----------|-------------------|
| Performance | 60fps 유지 | Canvas requestAnimationFrame |
| Responsiveness | 모바일 320px ~ 데스크톱 지원 | Canvas 동적 리사이즈 |
| UX | 블록 배치 즉각 반응 (<16ms) | 입력 처리 최적화 |
| Accessibility | 색상 구분 + 동물 아이콘으로 이중 식별 | 색약 대응 |

---

## 4. Game Design

### 4.1 게임 화면 구성

```
┌──────────────────────────────────────┐
│  Score: 2400   Stage: 3   ❤️❤️❤️       │
│  Lines: 12/20  Balance: ▰▰▰▱▱▱▱▱▱▰  │
├──────────────────────────────────────┤
│        🌧️ 비가 내리는 배경 🌧️         │
│                                      │
│        ┌──────────────┐   Next:      │
│        │              │   ┌────┐     │
│        │    🐘🐘      │   │🐦🐦│     │
│        │    🐘🐘      │   └────┘     │
│        │              │              │
│        │  🦁🐑🐑      │              │
│        │  🦁🦁🐑      │              │
│        │🐕🦁🐅🐅🐑    │              │
│        │🐕🐕🐅🐅🐑🐑  │              │
│        │🐄🐄🐄🐓🐓🐑  │              │
│        └──────────────┘              │
│    ⚖️ ──────●────────── ⚖️           │
│         (방주 균형 게이지)              │
│                                      │
│  🕹️ ←  ↻  →  ▼                      │
└──────────────────────────────────────┘
```

### 4.2 동물 블록 종류 (테트로미노 + 동물 매핑)

| 블록 모양 | 동물 | 무게 | 색상 | 특성 |
|-----------|------|------|------|------|
| I (4칸 일자) | 뱀 🐍 | 2 | 초록 | 가벼움, 좁은 틈 채우기 |
| O (2x2 사각) | 코끼리 🐘 | 5 | 회색 | 무거움, 균형 주의 |
| T (T자) | 사자 🦁 | 3 | 주황 | 보통 |
| S (S자) | 양 🐑 | 2 | 흰색 | 가벼움 |
| Z (Z자) | 독수리 🦅 | 2 | 갈색 | 가벼움 |
| L (L자) | 기린 🦒 | 3 | 노랑 | 보통 |
| J (J자 역) | 곰 🐻 | 4 | 진갈색 | 약간 무거움 |
| ★ (퀴즈 특수) | 비둘기 🕊️ | 1 | 금색 | 퀴즈 트리거 |

### 4.3 방주 균형 시스템

```
Balance Meter:
LEFT ▰▰▰▰▰●▱▱▱▱▱ RIGHT
         ↑ center

- 블록이 왼쪽에 배치되면 게이지가 왼쪽으로 이동
- 블록이 오른쪽에 배치되면 게이지가 오른쪽으로 이동
- 무게(weight) × 중심으로부터 거리 = 토크 (torque)
- 좌 토크 합 vs 우 토크 합의 차이로 기울기 계산
- 기울기 임계값(threshold) 초과 시:
  - 경고 단계: 화면 흔들림 + 경고 메시지 ("방주가 기울어집니다!")
  - 게임 오버: 임계값 2배 초과 시 방주 전복 → 게임 오버
```

**균형 계산 공식:**
```
tilt = Σ(weight × (col - center)) / totalWeight
if |tilt| > WARNING_THRESHOLD → 경고
if |tilt| > GAMEOVER_THRESHOLD → 게임 오버
```

### 4.4 스테이지 설계

| Stage | 목표 줄 수 | 보드 크기 | 낙하 속도 | 퀴즈 블록 | 특징 |
|-------|-----------|----------|----------|----------|------|
| 1 | 10줄 | 10×20 | 느림 (1000ms) | 2개 | 튜토리얼, 균형 쉬움 |
| 2 | 15줄 | 10×20 | 보통 (800ms) | 3개 | 균형 민감도 증가 |
| 3 | 20줄 | 10×20 | 보통 (650ms) | 4개 | 무거운 블록 빈출 |
| 4 | 25줄 | 10×20 | 빠름 (500ms) | 5개 | 균형 임계값 축소 |
| 5 | 30줄 | 10×20 | 빠름 (400ms) | 6개 | 최종, 폭우 연출 |

### 4.5 스테이지 클리어 연출

```
비가 서서히 멈춤 → 하늘이 밝아짐 → 무지개 애니메이션 등장
→ 성경 구절 표시 → "다음 스테이지" 버튼

Stage 1 → "하나님이 노아에게 이르시되 너는 방주를 지으라" (창 6:14)
Stage 2 → "노아가 모든 것을 하나님이 명하신 대로 행하였더라" (창 6:22)
Stage 3 → "여호와께서 그 뒤를 닫으시니라" (창 7:16)
Stage 4 → "물이 땅에서 줄어들기 시작하여" (창 8:3)
Stage 5 → "내가 무지개를 구름 속에 두었나니 이것이 나와 세상 사이의 언약의 증거니라" (창 9:13)
```

### 4.6 보상 체계

| 조건 | 달란트 |
|------|--------|
| 게임 참여 (최소 1스테이지 클리어) | 1 |
| 3스테이지 클리어 | 3 (누적) |
| 전체 클리어 (5스테이지) | 5 (누적) |
| 퀴즈 전문 정답 보너스 | +2 |

일일 보상 제한: 3회 (brick-breaker와 별도 카운트)

---

## 5. Technical Design

### 5.1 파일 구조

```
src/app/(dashboard)/games/
  page.tsx                          # 게임 목록 — "노아의 방주" 카드 추가
  noahs-ark/
    page.tsx                        # 게임 래퍼 페이지 (서버 컴포넌트)
    _components/
      NoahsArkGame.tsx              # 메인 게임 컴포넌트 (Canvas, client)
      NoahsArkWrapper.tsx           # 학생 선택 + 게임 래퍼
      QuizModal.tsx                 # 퀴즈 팝업 (노아 관련)
      GameOverModal.tsx             # 게임 결과 + 보상
      RainbowAnimation.tsx          # 스테이지 클리어 무지개 연출
    _lib/
      types.ts                      # 게임 타입 정의
      gameEngine.ts                 # 테트리스 로직 (블록, 보드, 충돌)
      blocks.ts                     # 7종 블록 정의 + 동물 매핑
      balance.ts                    # 방주 균형 물리 엔진
      stages.ts                     # 5개 스테이지 설정
      renderer.ts                   # Canvas 렌더링 (비/무지개 포함)

src/app/api/games/noahs-ark/
  reward/route.ts                   # 달란트 보상 API
```

### 5.2 기술 선택

| 항목 | 선택 | 이유 |
|------|------|------|
| 렌더링 | HTML5 Canvas + React | brick-breaker와 동일 패턴 |
| 게임 루프 | requestAnimationFrame | 60fps, 타이머 기반 블록 낙하 |
| 물리 엔진 | 커스텀 (balance.ts) | 단순 토크 계산, 외부 라이브러리 불필요 |
| 비/무지개 연출 | Canvas 파티클 시스템 | 가벼운 파티클로 비 표현 |
| 퀴즈 데이터 | 노아 관련 퀴즈 하드코딩 | 10~15문제, DB 확장 시 API 전환 가능 |
| 터치 입력 | 스와이프 제스처 인식 | 터치 시작/종료 좌표 비교 |
| 보상 API | 기존 brick-breaker 패턴 복사 | 일관성, `type: 'game'` |

### 5.3 게임 엔진 핵심 로직

```
Game Loop:
1. 입력 처리 (키보드/터치)
2. 타이머 체크 → 블록 자동 낙하
3. 충돌 감지 (블록 vs 보드 하단/기존 블록)
4. 블록 착지 시:
   a. 보드에 블록 고정
   b. 균형 재계산 (토크)
   c. 완성 줄 체크 → 줄 제거 + 점수
   d. 퀴즈 블록이면 퀴즈 트리거
   e. 목표 줄 달성 시 스테이지 클리어
   f. 블록 쌓여서 꼭대기 도달 시 게임 오버
5. 렌더링 (보드, 블록, 비, 균형 게이지, HUD)
6. 다음 프레임 요청
```

---

## 6. Success Criteria

### 6.1 Definition of Done

- [ ] 게임 목록 페이지에 "노아의 방주" 카드 활성화
- [ ] 테트리스 블록 낙하 + 배치 정상 동작
- [ ] 블록 회전/이동/드롭 조작 정상
- [ ] 방주 균형 시스템 동작 (기울기 경고 + 게임오버)
- [ ] 줄 완성 시 제거 + 점수 획득
- [ ] 5개 스테이지 진행 + 무지개 클리어 연출
- [ ] 퀴즈 블록 동작 (퀴즈 팝업)
- [ ] 달란트 보상 지급 (하루 3회 제한)
- [ ] 모바일 터치 조작 정상
- [ ] 빌드 성공 (npm run build)

### 6.2 Quality Criteria

- [ ] Zero lint errors
- [ ] 빌드 에러 없음
- [ ] 모바일/데스크톱 정상 동작
- [ ] 60fps 유지

---

## 7. Risks and Mitigation

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| 균형 물리 복잡도 → 개발 지연 | Medium | Medium | 단순 토크 계산으로 시작, 점진 개선 |
| 모바일 터치 조작 UX | High | Medium | 명확한 제스처 가이드 + 버튼 대체 제공 |
| Canvas 모바일 성능 | Medium | Low | 파티클 수 제한, 비 효과 최적화 |
| 기울기 밸런스 게임 플레이 난이도 | Medium | High | 스테이지별 임계값 조정, 테스트 후 튜닝 |
| 달란트 어뷰징 | High | Medium | 게임별 일일 3회 제한, 서버 검증 |

---

## 8. Noah's Ark Quiz Data (하드코딩)

노아 방주 관련 성경 퀴즈 15문제 (게임 내 사용):

| # | 질문 | 정답 |
|---|------|------|
| 1 | 노아가 방주를 만든 나무는? | 잣나무 (고페르 나무) |
| 2 | 방주에 들어간 동물은 몇 쌍씩? | 2쌍 (정결한 짐승 7쌍) |
| 3 | 비가 며칠 동안 내렸나요? | 40일 40야 |
| 4 | 노아가 먼저 보낸 새는? | 까마귀 |
| 5 | 올리브 잎을 물고 온 새는? | 비둘기 |
| 6 | 하나님이 약속의 표시로 보여주신 것은? | 무지개 |
| 7 | 노아의 세 아들 이름은? | 셈, 함, 야벳 |
| 8 | 방주의 길이는 몇 규빗? | 300규빗 |
| 9 | 방주의 층수는? | 3층 |
| 10 | 홍수 이야기는 창세기 몇 장? | 6~9장 |

---

## 9. Next Steps

1. [x] Plan 문서 작성 완료
2. [ ] Design 문서 작성 (`/pdca design noahs-ark-tetris`)
3. [ ] 구현 시작 (`/pdca do noahs-ark-tetris`)
4. [ ] Gap Analysis (`/pdca analyze noahs-ark-tetris`)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-02-16 | Initial draft | AI Assistant |
