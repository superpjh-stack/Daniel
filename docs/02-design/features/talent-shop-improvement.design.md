# Talent Shop Improvement Design Document

> **Summary**: ë‹¬ë€íŠ¸ ì‹œì¥ ê°œì„  - ìƒí’ˆ ê´€ë¦¬, íŠ¸ëœì­ì…˜ ì›ìì„±, ê¶Œí•œ ì œì–´, êµ¬ë§¤ ì´ë ¥, ì¹´í…Œê³ ë¦¬, ë°°ì§€ ê¸°ìˆ  ì„¤ê³„
>
> **Project**: daniel (ë™ì€êµíšŒ ì´ˆë“±ë¶€ ì¶œì„/ë‹¬ë€íŠ¸ ê´€ë¦¬)
> **Version**: 1.0.0
> **Author**: Claude Code
> **Date**: 2026-02-13
> **Status**: Draft
> **Planning Doc**: [talent-shop-improvement.plan.md](../../01-plan/features/talent-shop-improvement.plan.md)

---

## 1. Overview

### 1.1 Design Goals

- ê¸°ì¡´ ìƒì  ì½”ë“œ êµ¬ì¡°(db.ts â†’ API Route â†’ page.tsx)ë¥¼ ìœ ì§€í•˜ë©´ì„œ í™•ì¥
- better-sqlite3ì˜ `transaction()` ë©”ì„œë“œë¡œ êµ¬ë§¤ íŠ¸ëœì­ì…˜ ì›ìì„± ë³´ì¥
- ê´€ë¦¬ì ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ë¥¼ API ë ˆë²¨ì—ì„œ ì ìš©
- ë™ì  ë¼ìš°íŠ¸(`[id]`)ë¥¼ í™œìš©í•œ ê°œë³„ ìƒí’ˆ ìˆ˜ì •/ì‚­ì œ API
- ëª¨ë°”ì¼ ìš°ì„  UX: ì¹´í…Œê³ ë¦¬ í•„í„°, ë°°ì§€, êµ¬ë§¤ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸

### 1.2 Design Principles

- **ê¸°ì¡´ íŒ¨í„´ ìœ ì§€**: ìƒˆ DB ì—°ê²° â†’ ì¿¼ë¦¬ â†’ ì—°ê²° ë‹«ê¸° íŒ¨í„´ (ë‹¨, íŠ¸ëœì­ì…˜ í•¨ìˆ˜ëŠ” ë‹¨ì¼ ì—°ê²°ì—ì„œ ì²˜ë¦¬)
- **ìµœì†Œ ë³€ê²½**: ê¸°ì¡´ íŒŒì¼ì— ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ë˜, êµ¬ì¡°ì  ë¦¬íŒ©í† ë§ì€ í•˜ì§€ ì•ŠìŒ
- **í•˜ìœ„ í˜¸í™˜ì„±**: ê¸°ì¡´ API ìš”ì²­/ì‘ë‹µ í˜•ì‹ ìœ ì§€, ìƒˆ í•„ë“œëŠ” ì„ íƒì ìœ¼ë¡œ ì¶”ê°€
- **ìŠ¤í‚¤ë§ˆ ë³€ê²½ ìµœì†Œí™”**: Product ëª¨ë¸ì— `category` ì»¬ëŸ¼ë§Œ ì¶”ê°€, ë‚˜ë¨¸ì§€ëŠ” ê¸°ì¡´ ì»¬ëŸ¼ í™œìš©

---

## 2. Architecture

### 2.1 Component Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  shop/page.tsx (Client Component)                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Category â”‚ â”‚ Product  â”‚ â”‚ Product  â”‚ â”‚ Admin Product  â”‚  â”‚
â”‚  â”‚ Filter   â”‚ â”‚ Grid     â”‚ â”‚ Badges   â”‚ â”‚ Edit/Delete    â”‚  â”‚
â”‚  â”‚ (ì‹ ê·œ)   â”‚ â”‚ (ê¸°ì¡´+)  â”‚ â”‚ (ì‹ ê·œ)   â”‚ â”‚ (ì‹ ê·œ)         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Purchase Confirm â”‚ â”‚ Purchase History Modal            â”‚   â”‚
â”‚  â”‚ Dialog (ì‹ ê·œ)    â”‚ â”‚ (ì‹ ê·œ)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Product Form Modal (ê¸°ì¡´ + ìˆ˜ì • ëª¨ë“œ ì¶”ê°€)               â”‚â”‚
â”‚  â”‚  + ì´ë¯¸ì§€ URL ì…ë ¥ (ì‹ ê·œ)                                â”‚â”‚
â”‚  â”‚  + ì¹´í…Œê³ ë¦¬ ì„ íƒ (ì‹ ê·œ)                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ fetch()
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API Routes                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /api/shop/products     â”‚ â”‚ /api/shop/products/[id]      â”‚ â”‚
â”‚  â”‚  GET: ê¸°ì¡´ (ë³€ê²½ ì—†ìŒ) â”‚ â”‚  PUT: ìƒí’ˆ ìˆ˜ì • (ì‹ ê·œ)       â”‚ â”‚
â”‚  â”‚  POST: + admin ì²´í¬    â”‚ â”‚  DELETE: ìƒí’ˆ ë¹„í™œì„±í™” (ì‹ ê·œ) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ /api/shop/purchase     â”‚ â”‚ /api/shop/history (ì‹ ê·œ)      â”‚ â”‚
â”‚  â”‚  POST: íŠ¸ëœì­ì…˜ ì ìš©   â”‚ â”‚  GET: í•™ìƒë³„ êµ¬ë§¤ ì´ë ¥        â”‚ â”‚
â”‚  â”‚   + ì”ì•¡ ìŒìˆ˜ ë°©ì§€     â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  src/lib/db.ts (Data Access Layer)                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ ê¸°ì¡´ í•¨ìˆ˜:                                               â”‚ â”‚
â”‚  â”‚  getAllProducts, getProductById, createProduct,           â”‚ â”‚
â”‚  â”‚  updateProductStock, createTalentRecord,                  â”‚ â”‚
â”‚  â”‚  getStudentById, updateStudentTalentBalance               â”‚ â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚  â”‚ ì‹ ê·œ í•¨ìˆ˜:                                               â”‚ â”‚
â”‚  â”‚  updateProduct(id, data)                                  â”‚ â”‚
â”‚  â”‚  deactivateProduct(id)                                    â”‚ â”‚
â”‚  â”‚  executePurchaseTransaction(productId, studentId, qty)    â”‚ â”‚
â”‚  â”‚  getStudentPurchaseHistory(studentId, limit)              â”‚ â”‚
â”‚  â”‚  getProductPurchaseCount(productId)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  prisma/dev.db (SQLite)  â”‚
â”‚  Product: +category ì»¬ëŸ¼ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Data Flow

#### êµ¬ë§¤ íŠ¸ëœì­ì…˜ Flow (FR-06, FR-07)
```
êµì‚¬: í•™ìƒ ì„ íƒ â†’ ìˆ˜ëŸ‰ ì„ íƒ â†’ "êµ¬ë§¤í•˜ê¸°" í´ë¦­
  â†’ êµ¬ë§¤ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (FR-09)
  â†’ POST /api/shop/purchase
  â†’ API: ê²€ì¦ (ìƒí’ˆ, í•™ìƒ, ì¬ê³ , ì”ì•¡)
  â†’ DB: executePurchaseTransaction() [ë‹¨ì¼ íŠ¸ëœì­ì…˜]
    â†’ 1. ì¬ê³  ì°¨ê° (stock - quantity)
    â†’ 2. ì”ì•¡ ê²€ì¦ (balance >= totalPrice)
    â†’ 3. ì”ì•¡ ì°¨ê° (balance - totalPrice)
    â†’ 4. Talent ê¸°ë¡ ìƒì„±
  â†’ ì‘ë‹µ: { success, remainingBalance, remainingStock }
```

#### ìƒí’ˆ ìˆ˜ì • Flow (FR-01)
```
ê´€ë¦¬ì: ìƒí’ˆ ì¹´ë“œ í¸ì§‘ ì•„ì´ì½˜ í´ë¦­
  â†’ ìƒí’ˆ í¼ ëª¨ë‹¬ (ìˆ˜ì • ëª¨ë“œ, ê¸°ì¡´ ë°ì´í„° pre-fill)
  â†’ PUT /api/shop/products/{id}
  â†’ API: admin ê¶Œí•œ ì²´í¬ â†’ updateProduct()
  â†’ ìƒì  í˜ì´ì§€ ê°±ì‹ 
```

#### êµ¬ë§¤ ì´ë ¥ ì¡°íšŒ Flow (FR-05)
```
êµì‚¬: í•™ìƒ ì„ íƒ â†’ "êµ¬ë§¤ ì´ë ¥" ë²„íŠ¼ í´ë¦­
  â†’ GET /api/shop/history?studentId={id}&limit=20
  â†’ DB: getStudentPurchaseHistory()
  â†’ ëª¨ë‹¬ì— ì´ë ¥ í‘œì‹œ
```

### 2.3 Dependencies

| Component | Depends On | Purpose |
|-----------|-----------|---------|
| shop/page.tsx | /api/shop/products, /api/shop/purchase, /api/shop/history | ìƒí’ˆ CRUD ë° êµ¬ë§¤, ì´ë ¥ |
| /api/shop/products POST/PUT/DELETE | db.ts: createProduct, updateProduct, deactivateProduct | ìƒí’ˆ ê´€ë¦¬ |
| /api/shop/purchase POST | db.ts: executePurchaseTransaction | ì›ìì  êµ¬ë§¤ |
| /api/shop/history | db.ts: getStudentPurchaseHistory | êµ¬ë§¤ ì´ë ¥ ì¡°íšŒ |
| /api/shop/products/[id] | db.ts: updateProduct, deactivateProduct | ê°œë³„ ìƒí’ˆ ê´€ë¦¬ |

---

## 3. Data Model

### 3.1 Product ëª¨ë¸ ë³€ê²½

```
Product í…Œì´ë¸” (ê¸°ì¡´ + category ì»¬ëŸ¼ ì¶”ê°€)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Column     â”‚ Type       â”‚ Notes                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id         â”‚ String PK  â”‚ ê¸°ì¡´                          â”‚
â”‚ name       â”‚ String     â”‚ ê¸°ì¡´                          â”‚
â”‚ descriptionâ”‚ String?    â”‚ ê¸°ì¡´                          â”‚
â”‚ price      â”‚ Int        â”‚ ê¸°ì¡´                          â”‚
â”‚ stock      â”‚ Int        â”‚ ê¸°ì¡´                          â”‚
â”‚ image      â”‚ String?    â”‚ ê¸°ì¡´ (ì´ë¯¸ì§€ URL ì €ì¥)        â”‚
â”‚ category   â”‚ String?    â”‚ ì‹ ê·œ (ê¸°ë³¸ê°’: "ê¸°íƒ€")         â”‚
â”‚ isActive   â”‚ Boolean    â”‚ ê¸°ì¡´ (soft delete í™œìš©)       â”‚
â”‚ createdAt  â”‚ DateTime   â”‚ ê¸°ì¡´                          â”‚
â”‚ updatedAt  â”‚ DateTime   â”‚ ê¸°ì¡´                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì¹´í…Œê³ ë¦¬ ê°’ (FR-08):**

| Value | Label | Description |
|-------|-------|-------------|
| `school` | í•™ìš©í’ˆ | ì—°í•„, ì§€ìš°ê°œ, ë…¸íŠ¸ ë“± |
| `snack` | ê°„ì‹ | ì‚¬íƒ•, ê³¼ì, ìŒë£Œ ë“± |
| `culture` | ë¬¸í™” | ìŠ¤í‹°ì»¤, íŒ”ì°Œ, ì—´ì‡ ê³ ë¦¬ ë“± |
| `special` | íŠ¹ë³„ | ê¸°í”„íŠ¸ì¹´ë“œ, íŠ¹ë³„ ìƒí’ˆ |
| `etc` | ê¸°íƒ€ | ë¶„ë¥˜ ì—†ìŒ (ê¸°ë³¸ê°’) |

### 3.2 Entity Relationships (ë³€ê²½ ì—†ìŒ)

```
[Student] 1 â”€â”€â”€â”€ N [Talent]  (type: 'purchase' â†’ êµ¬ë§¤ ê¸°ë¡)
                     â”‚
                     â””â”€â”€ reason í•„ë“œì— ìƒí’ˆëª… í¬í•¨
                         (ì˜ˆ: "ì—°í•„ ì„¸íŠ¸ 2ê°œ êµ¬ë§¤")

[Product] â† ì§ì ‘ì ì¸ FK ê´€ê³„ ì—†ìŒ (Talent.reasonìœ¼ë¡œ ê°„ì ‘ ì°¸ì¡°)
```

### 3.3 ìŠ¤í‚¤ë§ˆ ë³€ê²½

**Prisma ìŠ¤í‚¤ë§ˆ ë³€ê²½ (ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”):**

```prisma
model Product {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Int
  stock       Int      @default(0)
  image       String?
  category    String?  // ì‹ ê·œ ì¶”ê°€
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
```

> `category`ë¥¼ nullable Stringìœ¼ë¡œ ì¶”ê°€í•˜ì—¬ ê¸°ì¡´ ë°ì´í„°ì— ì˜í–¥ ì—†ìŒ. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œ ê¸°ì¡´ ìƒí’ˆì€ `null` â†’ ì½”ë“œì—ì„œ `"etc"` ê¸°ë³¸ê°’ ì²˜ë¦¬.

---

## 4. API Specification

### 4.1 Endpoint List

| Method | Path | Description | Auth | Admin | Status |
|--------|------|-------------|------|-------|--------|
| GET | `/api/shop/products` | í™œì„± ìƒí’ˆ ëª©ë¡ | Required | No | ê¸°ì¡´ (ë³€ê²½ ì—†ìŒ) |
| POST | `/api/shop/products` | ìƒí’ˆ ìƒì„± | Required | **Yes** | **ìˆ˜ì •** |
| PUT | `/api/shop/products/[id]` | ìƒí’ˆ ìˆ˜ì • | Required | **Yes** | **ì‹ ê·œ** |
| DELETE | `/api/shop/products/[id]` | ìƒí’ˆ ë¹„í™œì„±í™” | Required | **Yes** | **ì‹ ê·œ** |
| POST | `/api/shop/purchase` | ìƒí’ˆ êµ¬ë§¤ | Required | No | **ìˆ˜ì •** |
| GET | `/api/shop/history` | êµ¬ë§¤ ì´ë ¥ ì¡°íšŒ | Required | No | **ì‹ ê·œ** |

### 4.2 Detailed Specification

---

#### `POST /api/shop/products` (ìˆ˜ì • - ê´€ë¦¬ì ê¶Œí•œ ì¶”ê°€)

**ë³€ê²½ì‚¬í•­:** `session.role === 'admin'` ì²´í¬ ì¶”ê°€, `image`, `category` í•„ë“œ ì¶”ê°€

**Request:**
```json
{
  "name": "ì—°í•„ ì„¸íŠ¸",
  "description": "HB ì—°í•„ 6ìë£¨",
  "price": 10,
  "stock": 20,
  "image": "https://example.com/pencil.jpg",
  "category": "school"
}
```

**Response (201):**
```json
{
  "id": "product-xxx",
  "name": "ì—°í•„ ì„¸íŠ¸",
  "price": 10
}
```

**Error Responses:**
```json
// 403: ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš°
{ "error": "ê´€ë¦¬ìë§Œ ìƒí’ˆì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." }
```

---

#### `PUT /api/shop/products/[id]` (ì‹ ê·œ)

**Request:**
```json
{
  "name": "ì—°í•„ ì„¸íŠ¸ (ìˆ˜ì •)",
  "description": "HB ì—°í•„ 12ìë£¨",
  "price": 15,
  "stock": 30,
  "image": "https://example.com/pencil-new.jpg",
  "category": "school"
}
```

**Response (200):**
```json
{ "success": true }
```

**Error Responses:**
```json
// 403: ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš°
{ "error": "ê´€ë¦¬ìë§Œ ìƒí’ˆì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." }
// 404: ìƒí’ˆ ì—†ìŒ
{ "error": "ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." }
```

---

#### `DELETE /api/shop/products/[id]` (ì‹ ê·œ)

Soft delete: `isActive = false`ë¡œ ë³€ê²½.

**Response (200):**
```json
{ "success": true }
```

**Error Responses:**
```json
// 403: ê´€ë¦¬ìê°€ ì•„ë‹Œ ê²½ìš°
{ "error": "ê´€ë¦¬ìë§Œ ìƒí’ˆì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." }
// 404: ìƒí’ˆ ì—†ìŒ
{ "error": "ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." }
```

---

#### `POST /api/shop/purchase` (ìˆ˜ì • - íŠ¸ëœì­ì…˜ + ì”ì•¡ ê²€ì¦)

ê¸°ì¡´ APIì™€ ë™ì¼í•œ ìš”ì²­/ì‘ë‹µ í˜•ì‹ì´ì§€ë§Œ, ë‚´ë¶€ì ìœ¼ë¡œ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ì²˜ë¦¬.

**Request (ë³€ê²½ ì—†ìŒ):**
```json
{
  "productId": "product-xxx",
  "studentId": "student-xxx",
  "quantity": 2
}
```

**Response (ìˆ˜ì • - ì¶”ê°€ ì •ë³´ í¬í•¨):**
```json
{
  "success": true,
  "remainingBalance": 80,
  "remainingStock": 18
}
```

**Error Responses (ìˆ˜ì •):**
```json
// 400: ìˆ˜ëŸ‰ ê²€ì¦
{ "error": "ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤." }
// 400: ì¬ê³  ë¶€ì¡±
{ "error": "ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." }
// 400: ì”ì•¡ ë¶€ì¡±
{ "error": "ë‹¬ë€íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." }
```

**ë³€ê²½ ë¡œì§:**
1. ê¸°ì¡´: 3ê°œì˜ ë³„ë„ DB í˜¸ì¶œ (stock ì°¨ê° â†’ balance ì°¨ê° â†’ talent ìƒì„±)
2. ë³€ê²½: `executePurchaseTransaction()` ë‹¨ì¼ íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë¬¶ê¸°
3. íŠ¸ëœì­ì…˜ ë‚´ ì”ì•¡ ì¬í™•ì¸ (race condition ë°©ì§€)

---

#### `GET /api/shop/history` (ì‹ ê·œ)

**Request:**
```
GET /api/shop/history?studentId=xxx&limit=20
```

**Response:**
```json
{
  "purchases": [
    {
      "id": "talent-xxx",
      "amount": -20,
      "reason": "ì—°í•„ ì„¸íŠ¸ 2ê°œ êµ¬ë§¤",
      "createdAt": "2026-02-13T10:30:00Z"
    }
  ],
  "totalSpent": 150,
  "purchaseCount": 8
}
```

---

## 5. UI/UX Design

### 5.1 ìƒì  í˜ì´ì§€ ë ˆì´ì•„ì›ƒ (ìˆ˜ì • í›„)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Header: "ë‹¬ë€íŠ¸ ì‹œì¥"                â”‚
â”‚  subtitle: "ë‹¬ë€íŠ¸ë¡œ ìƒí’ˆì„ êµ¬ë§¤í•˜ì„¸ìš”!" â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ì¹´í…Œê³ ë¦¬ í•„í„° (FR-08)]             â”‚
â”‚  [ì „ì²´] [í•™ìš©í’ˆ] [ê°„ì‹] [ë¬¸í™”] [íŠ¹ë³„] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [+ ìƒí’ˆ ì¶”ê°€] (ê´€ë¦¬ìë§Œ í‘œì‹œ)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [NEW] ğŸ·ï¸     â”‚ â”‚ [HOT] ğŸ·ï¸     â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚â”‚
â”‚  â”‚ â”‚  ì´ë¯¸ì§€    â”‚ â”‚ â”‚ â”‚  ì´ë¯¸ì§€    â”‚ â”‚â”‚
â”‚  â”‚ â”‚  or ğŸ“¦    â”‚ â”‚ â”‚ â”‚  or ğŸ“¦    â”‚ â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚â”‚
â”‚  â”‚ ì—°í•„ ì„¸íŠ¸     â”‚ â”‚ ì ¤ë¦¬ ì„¸íŠ¸     â”‚â”‚
â”‚  â”‚ â­ 10  20ê°œ  â”‚ â”‚ â­ 5   50ê°œ  â”‚â”‚
â”‚  â”‚              â”‚ â”‚              â”‚â”‚
â”‚  â”‚ [êµ¬ë§¤í•˜ê¸°]    â”‚ â”‚ [êµ¬ë§¤í•˜ê¸°]    â”‚â”‚
â”‚  â”‚ [âœï¸][ğŸ—‘ï¸]    â”‚ â”‚ [âœï¸][ğŸ—‘ï¸]    â”‚â”‚
â”‚  â”‚ (ê´€ë¦¬ìë§Œ)    â”‚ â”‚ (ê´€ë¦¬ìë§Œ)    â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [SOLD OUT]    â”‚ â”‚              â”‚â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ ...          â”‚â”‚
â”‚  â”‚ â”‚  ì´ë¯¸ì§€    â”‚ â”‚ â”‚              â”‚â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚              â”‚â”‚
â”‚  â”‚ ìŠ¤í˜ì…œ ì¹´ë“œ   â”‚ â”‚              â”‚â”‚
â”‚  â”‚ â­ 50  0ê°œ   â”‚ â”‚              â”‚â”‚
â”‚  â”‚ [í’ˆì ˆ]        â”‚ â”‚              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 User Flow

```
[ìƒì  í˜ì´ì§€ ì§„ì…]
  â”œâ†’ ì¹´í…Œê³ ë¦¬ í•„í„° ì„ íƒ (FR-08)
  â”œâ†’ ìƒí’ˆ ì¹´ë“œ í™•ì¸ (ë°°ì§€: NEW/HOT/SOLD OUT) (FR-10)
  â”œâ†’ "êµ¬ë§¤í•˜ê¸°" í´ë¦­
  â”‚   â””â†’ í•™ìƒ ì„ íƒ + ìˆ˜ëŸ‰ â†’ êµ¬ë§¤ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (FR-09)
  â”‚       "ì—°í•„ ì„¸íŠ¸ 2ê°œ, ì´ 20ë‹¬ë€íŠ¸ë¥¼ êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
  â”‚       â””â†’ í™•ì¸ â†’ êµ¬ë§¤ ì™„ë£Œ (íŠ¸ëœì­ì…˜) (FR-06)
  â”œâ†’ ê´€ë¦¬ì: "ìƒí’ˆ ì¶”ê°€" í´ë¦­ (FR-03)
  â”‚   â””â†’ ìƒí’ˆ í¼ (ì´ë¦„, ì„¤ëª…, ê°€ê²©, ì¬ê³ , ì´ë¯¸ì§€URL, ì¹´í…Œê³ ë¦¬)
  â”œâ†’ ê´€ë¦¬ì: âœï¸ (ìˆ˜ì •) í´ë¦­ (FR-01)
  â”‚   â””â†’ ìƒí’ˆ í¼ (ìˆ˜ì • ëª¨ë“œ, ê¸°ì¡´ ë°ì´í„° pre-fill)
  â”œâ†’ ê´€ë¦¬ì: ğŸ—‘ï¸ (ì‚­ì œ) í´ë¦­ (FR-02)
  â”‚   â””â†’ ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ â†’ soft delete
  â””â†’ "êµ¬ë§¤ ì´ë ¥" ë²„íŠ¼ (í•™ìƒ ì„ íƒ í›„) (FR-05)
      â””â†’ êµ¬ë§¤ ì´ë ¥ ëª¨ë‹¬ (ê¸ˆì•¡, ìƒí’ˆëª…, ë‚ ì§œ)
```

### 5.3 Component List

| Component/Section | Location | Responsibility | FR |
|-------------------|----------|----------------|----|
| CategoryFilter | shop/page.tsx (ì¸ë¼ì¸) | ì¹´í…Œê³ ë¦¬ íƒ­ í•„í„°ë§ | FR-08 |
| ProductCard | shop/page.tsx (ì¸ë¼ì¸) | ìƒí’ˆ ì¹´ë“œ + ë°°ì§€ + ì´ë¯¸ì§€ | FR-04, FR-10 |
| AdminActions | shop/page.tsx (ì¸ë¼ì¸) | ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ (ê´€ë¦¬ì) | FR-01, FR-02, FR-03 |
| ProductFormModal | shop/page.tsx (ì¸ë¼ì¸) | ìƒí’ˆ ìƒì„±/ìˆ˜ì • í¼ (ì´ë¯¸ì§€+ì¹´í…Œê³ ë¦¬) | FR-01, FR-04, FR-08 |
| PurchaseConfirmDialog | shop/page.tsx (ì¸ë¼ì¸) | êµ¬ë§¤ ì „ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ | FR-09 |
| PurchaseHistoryModal | shop/page.tsx (ì¸ë¼ì¸) | í•™ìƒë³„ êµ¬ë§¤ ì´ë ¥ ëª¨ë‹¬ | FR-05 |
| ProductBadge | shop/page.tsx (ì¸ë¼ì¸) | NEW/HOT/SOLD OUT ë°°ì§€ | FR-10 |

> ëª¨ë“  UIëŠ” shop/page.tsx íŒŒì¼ ë‚´ ì¸ë¼ì¸ìœ¼ë¡œ êµ¬í˜„ (ê¸°ì¡´ í”„ë¡œì íŠ¸ íŒ¨í„´ ìœ ì§€).

### 5.4 êµ¬ë§¤ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (FR-09)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          êµ¬ë§¤ í™•ì¸                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                      â”‚
â”‚  ğŸ›ï¸ ì—°í•„ ì„¸íŠ¸ Ã— 2ê°œ                â”‚
â”‚                                      â”‚
â”‚  ì´ ê²°ì œ ê¸ˆì•¡: â­ 20 ë‹¬ë€íŠ¸         â”‚
â”‚  ì”ì•¡: â­ 100 â†’ â­ 80              â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   ì·¨ì†Œ     â”‚ â”‚  êµ¬ë§¤ í™•ì¸  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.5 êµ¬ë§¤ ì´ë ¥ ëª¨ë‹¬ (FR-05)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ê¹€ë¯¼ì¤€ êµ¬ë§¤ ì´ë ¥              [ë‹«ê¸°] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì´ ì‚¬ìš©: â­ 150 | êµ¬ë§¤ 8ê±´         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  2026-02-13  ì—°í•„ ì„¸íŠ¸ 2ê°œ    -20   â”‚
â”‚  2026-02-06  ì ¤ë¦¬ ì„¸íŠ¸ 1ê°œ    -5    â”‚
â”‚  2026-01-30  ìŠ¤í‹°ì»¤ 3ê°œ       -15   â”‚
â”‚  ...                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.6 ìƒí’ˆ í¼ ëª¨ë‹¬ (ìˆ˜ì •) (FR-01, FR-04, FR-08)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ìƒí’ˆ ìˆ˜ì •                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ìƒí’ˆëª… *    [ì—°í•„ ì„¸íŠ¸          ]   â”‚
â”‚  ì„¤ëª…        [HB ì—°í•„ 6ìë£¨      ]   â”‚
â”‚  ê°€ê²©(ë‹¬ë€íŠ¸) [  10  ]  ì¬ê³  [  20 ] â”‚
â”‚  ì´ë¯¸ì§€ URL  [https://...        ]   â”‚
â”‚  ì¹´í…Œê³ ë¦¬    [í•™ìš©í’ˆ  â–¼]             â”‚
â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   ì·¨ì†Œ     â”‚ â”‚   ì €ì¥í•˜ê¸°  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Error Handling

### 6.1 API Error Responses

| Code | Endpoint | Message | Cause |
|------|----------|---------|-------|
| 400 | POST /api/shop/purchase | "ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤." | quantity < 1 |
| 400 | POST /api/shop/purchase | "ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." | stock < quantity |
| 400 | POST /api/shop/purchase | "ë‹¬ë€íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." | balance < totalPrice |
| 400 | POST /api/shop/products | "ìƒí’ˆëª…ê³¼ ê°€ê²©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤." | name/price ëˆ„ë½ |
| 400 | PUT /api/shop/products/[id] | "ìƒí’ˆëª…ê³¼ ê°€ê²©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤." | name/price ëˆ„ë½ |
| 400 | GET /api/shop/history | "studentIdê°€ í•„ìš”í•©ë‹ˆë‹¤." | íŒŒë¼ë¯¸í„° ëˆ„ë½ |
| 401 | All endpoints | "Unauthorized" | ë¯¸ì¸ì¦ |
| 403 | POST/PUT/DELETE products | "ê´€ë¦¬ìë§Œ ìƒí’ˆì„ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." | role !== 'admin' |
| 404 | PUT/DELETE /api/shop/products/[id] | "ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." | ìƒí’ˆ ì—†ìŒ |
| 500 | All endpoints | "Internal server error" | ì„œë²„ ì˜¤ë¥˜ |

### 6.2 Client-side Error Handling

| ìƒí™© | ì²˜ë¦¬ |
|------|------|
| êµ¬ë§¤ ì‹¤íŒ¨ | `alert()` ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ |
| ìƒí’ˆ ìˆ˜ì •/ì‚­ì œ ì‹¤íŒ¨ | `alert()` ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ |
| ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨ | ëª¨ë‹¬ì— "êµ¬ë§¤ ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤" í‘œì‹œ |
| ì´ë¯¸ì§€ ë¡œë”© ì‹¤íŒ¨ | Package ì•„ì´ì½˜ fallback |
| ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ | `console.error` + alert |

---

## 7. Security Considerations

- [x] ê´€ë¦¬ì ê¶Œí•œ ì²´í¬ (ìƒí’ˆ ìƒì„±/ìˆ˜ì •/ì‚­ì œì— `role === 'admin'`)
- [x] ì¸ì¦ í™•ì¸ (ëª¨ë“  APIì—ì„œ `getSession()`)
- [x] SQL Injection ë°©ì§€ (better-sqlite3 prepared statement)
- [x] íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
- [x] ì”ì•¡ ìŒìˆ˜ ë°©ì§€ (íŠ¸ëœì­ì…˜ ë‚´ ì¬í™•ì¸)
- [x] ì´ë¯¸ì§€ URL í‘œì‹œ ì‹œ XSS ë°©ì§€ (ReactëŠ” ìë™ ì´ìŠ¤ì¼€ì´í”„)
- [ ] Rate Limiting (í˜„ì¬ ë¯¸ì ìš© - ë‚´ë¶€ ì‹œìŠ¤í…œì´ë¯€ë¡œ ë¶ˆí•„ìš”)

---

## 8. Test Plan

### 8.1 ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ (Zero Script QA)

| # | ì‹œë‚˜ë¦¬ì˜¤ | ì˜ˆìƒ ê²°ê³¼ |
|---|----------|----------|
| 1 | ê´€ë¦¬ì: ìƒí’ˆ ìƒì„± (ì´ë¦„, ê°€ê²©, ì¬ê³ , ì´ë¯¸ì§€ URL, ì¹´í…Œê³ ë¦¬) | ìƒí’ˆ ëª©ë¡ì— í‘œì‹œ, ì´ë¯¸ì§€/ì¹´í…Œê³ ë¦¬ í¬í•¨ |
| 2 | ê´€ë¦¬ì: ìƒí’ˆ ìˆ˜ì • (ê°€ê²© ë³€ê²½) | ë³€ê²½ëœ ê°€ê²©ìœ¼ë¡œ í‘œì‹œ |
| 3 | ê´€ë¦¬ì: ìƒí’ˆ ì‚­ì œ | ëª©ë¡ì—ì„œ ì‚¬ë¼ì§ (DBì— isActive=0) |
| 4 | êµì‚¬: ìƒí’ˆ ìƒì„±/ìˆ˜ì •/ì‚­ì œ ì‹œë„ | 403 ì—ëŸ¬ |
| 5 | êµ¬ë§¤ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ | ìƒí’ˆëª…, ìˆ˜ëŸ‰, ì´ ê¸ˆì•¡ í‘œì‹œ |
| 6 | ì •ìƒ êµ¬ë§¤ | ì”ì•¡ ì°¨ê°, ì¬ê³  ê°ì†Œ, ê¸°ë¡ ìƒì„± (ì›ìì ) |
| 7 | ì”ì•¡ ë¶€ì¡± êµ¬ë§¤ ì‹œë„ | "ë‹¬ë€íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤" ì—ëŸ¬ |
| 8 | ì¬ê³  ì†Œì§„ ìƒí’ˆ êµ¬ë§¤ ì‹œë„ | ë²„íŠ¼ ë¹„í™œì„±í™”, SOLD OUT ë°°ì§€ |
| 9 | ì¹´í…Œê³ ë¦¬ í•„í„° | ì„ íƒí•œ ì¹´í…Œê³ ë¦¬ ìƒí’ˆë§Œ í‘œì‹œ |
| 10 | êµ¬ë§¤ ì´ë ¥ ì¡°íšŒ | í•™ìƒë³„ êµ¬ë§¤ ë‚´ì—­ ëª¨ë‹¬ í‘œì‹œ |
| 11 | ì´ë¯¸ì§€ URL ì—†ëŠ” ìƒí’ˆ | Package ì•„ì´ì½˜ í‘œì‹œ |
| 12 | ì‹ ê·œ ìƒí’ˆ (7ì¼ ì´ë‚´) | NEW ë°°ì§€ í‘œì‹œ |

---

## 9. Implementation Guide

### 9.1 íŒŒì¼ ë³€ê²½ ëª©ë¡

```
ë³€ê²½ë˜ëŠ” íŒŒì¼:
â”œâ”€â”€ prisma/schema.prisma                      (ìˆ˜ì •: Productì— category ì¶”ê°€)
â”œâ”€â”€ src/lib/db.ts                              (ìˆ˜ì •: 5ê°œ í•¨ìˆ˜ ì¶”ê°€)
â”œâ”€â”€ src/app/api/shop/products/route.ts         (ìˆ˜ì •: admin ê¶Œí•œ ì²´í¬)
â”œâ”€â”€ src/app/api/shop/purchase/route.ts         (ìˆ˜ì •: íŠ¸ëœì­ì…˜ ì ìš©)
â”œâ”€â”€ src/app/(dashboard)/shop/page.tsx          (ìˆ˜ì •: ì „ë©´ ê°œì„ )

ìƒˆë¡œ ìƒì„±ë˜ëŠ” íŒŒì¼:
â”œâ”€â”€ src/app/api/shop/products/[id]/route.ts    (ì‹ ê·œ: ìƒí’ˆ ìˆ˜ì •/ì‚­ì œ)
â””â”€â”€ src/app/api/shop/history/route.ts          (ì‹ ê·œ: êµ¬ë§¤ ì´ë ¥)
```

### 9.2 Implementation Order

#### Step 1: ìŠ¤í‚¤ë§ˆ ë³€ê²½ ë° ë§ˆì´ê·¸ë ˆì´ì…˜

```bash
# prisma/schema.prismaì— category ì»¬ëŸ¼ ì¶”ê°€ í›„
npx prisma migrate dev --name add-product-category
```

#### Step 2: DB í•¨ìˆ˜ ì¶”ê°€ (`src/lib/db.ts`)

```typescript
// 2-1. ìƒí’ˆ ìˆ˜ì •
export function updateProduct(id: string, data: {
  name: string; description?: string; price: number;
  stock: number; image?: string; category?: string;
}): void {
  // UPDATE Product SET name=?, description=?, price=?, stock=?, image=?, category=?, updatedAt=datetime('now') WHERE id=?
}

// 2-2. ìƒí’ˆ ë¹„í™œì„±í™” (soft delete)
export function deactivateProduct(id: string): void {
  // UPDATE Product SET isActive = 0, updatedAt = datetime('now') WHERE id = ?
}

// 2-3. êµ¬ë§¤ íŠ¸ëœì­ì…˜ (í•µì‹¬!)
export function executePurchaseTransaction(
  productId: string, studentId: string, quantity: number
): { remainingBalance: number; remainingStock: number } {
  const db = createDb();
  try {
    const result = db.transaction(() => {
      // 1. ìƒí’ˆ ì¡°íšŒ + ì¬ê³  í™•ì¸
      const product = db.prepare('SELECT * FROM Product WHERE id = ?').get(productId);
      if (!product || product.stock < quantity) throw new Error('STOCK_INSUFFICIENT');

      // 2. í•™ìƒ ì¡°íšŒ + ì”ì•¡ í™•ì¸
      const student = db.prepare('SELECT * FROM Student WHERE id = ?').get(studentId);
      const totalPrice = product.price * quantity;
      if (!student || student.talentBalance < totalPrice) throw new Error('BALANCE_INSUFFICIENT');

      // 3. ì¬ê³  ì°¨ê°
      db.prepare('UPDATE Product SET stock = stock - ?, updatedAt = datetime("now") WHERE id = ?')
        .run(quantity, productId);

      // 4. ì”ì•¡ ì°¨ê°
      db.prepare('UPDATE Student SET talentBalance = talentBalance - ?, updatedAt = datetime("now") WHERE id = ?')
        .run(totalPrice, studentId);

      // 5. ê¸°ë¡ ìƒì„±
      const talentId = `talent-${Date.now()}-${Math.random().toString(36).substring(7)}`;
      db.prepare(`INSERT INTO Talent (id, studentId, amount, reason, type, createdAt)
        VALUES (?, ?, ?, ?, 'purchase', datetime('now'))`)
        .run(talentId, studentId, -totalPrice, `${product.name} ${quantity}ê°œ êµ¬ë§¤`);

      return {
        remainingBalance: student.talentBalance - totalPrice,
        remainingStock: product.stock - quantity,
      };
    })();
    return result;
  } finally {
    db.close();
  }
}

// 2-4. í•™ìƒë³„ êµ¬ë§¤ ì´ë ¥
export function getStudentPurchaseHistory(studentId: string, limit: number = 20): {
  purchases: { id: string; amount: number; reason: string; createdAt: string }[];
  totalSpent: number;
  purchaseCount: number;
} {
  // SELECT * FROM Talent WHERE studentId = ? AND type = 'purchase' ORDER BY createdAt DESC LIMIT ?
  // SELECT COUNT(*), SUM(ABS(amount)) FROM Talent WHERE studentId = ? AND type = 'purchase'
}

// 2-5. ìƒí’ˆë³„ êµ¬ë§¤ íšŸìˆ˜ (ì¸ê¸° ë°°ì§€ìš©)
export function getProductPurchaseCount(productId: string): number {
  // SELECT COUNT(*) FROM Talent WHERE type = 'purchase' AND reason LIKE '{productName}%'
  // ë˜ëŠ” ë³„ë„ approach: ìµœê·¼ 30ì¼ ë‚´ êµ¬ë§¤ ìˆ˜
}
```

#### Step 3: ìƒí’ˆ ê´€ë¦¬ API ìˆ˜ì • (`src/app/api/shop/products/route.ts`)

```typescript
// POST: admin ê¶Œí•œ ì²´í¬ ì¶”ê°€
// if (session.role !== 'admin') â†’ 403
// image, category íŒŒë¼ë¯¸í„° ì²˜ë¦¬
```

#### Step 4: ìƒí’ˆ ìˆ˜ì •/ì‚­ì œ API (`src/app/api/shop/products/[id]/route.ts`)

```typescript
// PUT: admin ì²´í¬ â†’ updateProduct()
// DELETE: admin ì²´í¬ â†’ deactivateProduct()
```

#### Step 5: êµ¬ë§¤ API ìˆ˜ì • (`src/app/api/shop/purchase/route.ts`)

```typescript
// ê¸°ì¡´ 3ê°œ ë³„ë„ í˜¸ì¶œ â†’ executePurchaseTransaction() ë‹¨ì¼ í˜¸ì¶œ
// ìˆ˜ëŸ‰ >= 1 ê²€ì¦ ì¶”ê°€
// ì‘ë‹µì— remainingBalance, remainingStock ì¶”ê°€
```

#### Step 6: êµ¬ë§¤ ì´ë ¥ API (`src/app/api/shop/history/route.ts`)

```typescript
// GET ?studentId={id}&limit=20
// â†’ getStudentPurchaseHistory()
```

#### Step 7: ìƒì  í˜ì´ì§€ UI ê°œì„  (`src/app/(dashboard)/shop/page.tsx`)

```typescript
// 7-1. ì‚¬ìš©ì ì„¸ì…˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (admin ì—¬ë¶€ íŒë‹¨)
// 7-2. ì¹´í…Œê³ ë¦¬ í•„í„° (FR-08)
// 7-3. ìƒí’ˆ ë°°ì§€ (FR-10): NEW (7ì¼ ì´ë‚´), HOT (êµ¬ë§¤ìˆ˜ >= 5), SOLD OUT (stock === 0)
// 7-4. ìƒí’ˆ ì´ë¯¸ì§€ í‘œì‹œ (FR-04): image URL or Package icon
// 7-5. ê´€ë¦¬ì ì•¡ì…˜ ë²„íŠ¼ (FR-01, FR-02): ìˆ˜ì •/ì‚­ì œ ì•„ì´ì½˜
// 7-6. ìƒí’ˆ í¼ ìˆ˜ì • ëª¨ë“œ (FR-01): ê¸°ì¡´ ëª¨ë‹¬ì— ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€, ì´ë¯¸ì§€/ì¹´í…Œê³ ë¦¬ í•„ë“œ
// 7-7. ì‚­ì œ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (FR-02)
// 7-8. êµ¬ë§¤ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ (FR-09)
// 7-9. êµ¬ë§¤ ì´ë ¥ ëª¨ë‹¬ (FR-05)
```

### 9.3 êµ¬í˜„ ìˆœì„œ ìš”ì•½

| ìˆœì„œ | ì‘ì—… | íŒŒì¼ | FR |
|-----|------|------|----|
| 1 | ìŠ¤í‚¤ë§ˆ ë³€ê²½ + ë§ˆì´ê·¸ë ˆì´ì…˜ | prisma/schema.prisma | FR-08 |
| 2 | DB í•¨ìˆ˜ ì¶”ê°€ | db.ts | FR-01,02,05,06,07,10 |
| 3 | ìƒí’ˆ API admin ì²´í¬ | api/shop/products/route.ts | FR-03 |
| 4 | ìƒí’ˆ ìˆ˜ì •/ì‚­ì œ API | api/shop/products/[id]/route.ts | FR-01,02,03 |
| 5 | êµ¬ë§¤ API íŠ¸ëœì­ì…˜ | api/shop/purchase/route.ts | FR-06,07 |
| 6 | êµ¬ë§¤ ì´ë ¥ API | api/shop/history/route.ts | FR-05 |
| 7 | ìƒì  í˜ì´ì§€ UI | shop/page.tsx | FR-01~10 ì „ì²´ |

---

## 10. Coding Convention Reference

### 10.1 ê¸°ì¡´ í”„ë¡œì íŠ¸ ê·œì¹™ (CLAUDE.md ê¸°ë°˜)

| Target | Rule | Example |
|--------|------|---------|
| DB í•¨ìˆ˜ | camelCase, get/create/update/deactivate/execute ì ‘ë‘ì‚¬ | `executePurchaseTransaction()` |
| API Route | `route.ts` íŒŒì¼ ë‚´ `GET`, `POST`, `PUT`, `DELETE` export | `export async function PUT()` |
| ë™ì  ë¼ìš°íŠ¸ | `[id]` í´ë” ë‚´ `route.ts` | `api/shop/products/[id]/route.ts` |
| ì»´í¬ë„ŒíŠ¸ | 'use client' í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸ | `export default function ShopPage()` |
| ID ìƒì„± | `{prefix}-${Date.now()}-${random}` | `product-${Date.now()}-xxx` |
| ì—ëŸ¬ ì‘ë‹µ | `{ error: string }` í˜•ì‹ | `{ error: 'Unauthorized' }` |
| ê¶Œí•œ ì²´í¬ | `session.role !== 'admin'` â†’ 403 | attendance-improvement ì„¤ì • API íŒ¨í„´ ì°¸ì¡° |

### 10.2 Import Order (ê¸°ì¡´ íŒ¨í„´ ìœ ì§€)

```typescript
// 1. React/Next.js
import { NextRequest, NextResponse } from 'next/server';
// 2. Internal libs
import { getSession } from '@/lib/auth';
import { functionName } from '@/lib/db';
```

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-02-13 | Initial draft | Claude Code |
