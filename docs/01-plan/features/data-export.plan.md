# data-export Plan

> **Feature**: 출석부 & 달란트 내역 출력 기능
>
> **Project**: daniel (동은교회 초등부 관리 시스템)
> **Author**: Claude (pdca planner)
> **Date**: 2026-02-18
> **Phase**: Plan

---

## 1. 기능 개요

### 1.1 목적

설정 메뉴에 새로운 "출력/내보내기" 탭을 추가하여, 관리자(admin)와 교사(teacher)가 **출석부**와 **달란트 내역**을 월별 또는 연별로 필터링해 인쇄하거나 다운로드할 수 있는 기능을 제공한다.

### 1.2 사용자 스토리

| ID | 역할 | 원하는 것 | 이유 |
|----|------|-----------|------|
| US-01 | 교사 | 특정 월의 출석부를 반별로 출력 | 종이 출석부 보관 및 부모 공유 |
| US-02 | 관리자 | 연간 출석 통계를 출력 | 연말 보고서 작성 |
| US-03 | 교사 | 특정 월의 달란트 지급 내역을 출력 | 달란트 사용 내역 투명성 확보 |
| US-04 | 관리자 | 연간 달란트 내역을 학생별로 출력 | 연간 정산 및 감사 |

---

## 2. 기능 요구사항

### 2.1 출력 탭 추가 (설정 페이지)

- 기존 탭(사용자, 반, 달란트, 학부모, 텔레그램)에 **"출력"** 탭 추가
- admin/teacher 모두 접근 가능
- 탭 내에 두 섹션: **출석부 출력**, **달란트 내역 출력**

### 2.2 공통 필터 옵션

| 필터 | 옵션 | 설명 |
|------|------|------|
| 기간 유형 | 월별 / 연별 | 라디오 버튼 |
| 연도 | 현재 연도 기준 ±3년 | 드롭다운 (2023~2026+) |
| 월 | 1~12월 | 드롭다운 (월별 선택 시 활성화) |
| 반 | 전체 / 특정 반 | 드롭다운 |

### 2.3 출석부 출력

**표시 컬럼**:
- 학생 이름, 학년, 반명
- 날짜별 출석 상태 (출석/지각/결석)
- 월간 합계 (출석 횟수, 출석률)

**출력 형식**:
- 화면 미리보기 (테이블)
- 브라우저 인쇄(`window.print()`) 지원
- CSV 다운로드

### 2.4 달란트 내역 출력

**표시 컬럼**:
- 학생 이름, 학년, 반명
- 날짜, 유형(출석/보너스/구매), 금액, 사유
- 월/연 합계 달란트 지급/차감

**출력 형식**:
- 화면 미리보기 (테이블)
- 브라우저 인쇄(`window.print()`) 지원
- CSV 다운로드

---

## 3. 기술 스택 및 접근 방식

### 3.1 새로운 API 엔드포인트

| 엔드포인트 | 메서드 | 설명 |
|-----------|--------|------|
| `/api/export/attendance` | GET | 월별/연별 출석 데이터 조회 |
| `/api/export/talent` | GET | 월별/연별 달란트 내역 조회 |

**쿼리 파라미터**:
```
?year=2026&month=2&classId=xxx&format=json
```
- `year`: 연도 (필수)
- `month`: 월 (선택, 없으면 연간)
- `classId`: 반 ID (선택, 없으면 전체)
- `format`: `json` | `csv` (기본값 json)

### 3.2 새로운 DB 함수 (db.ts)

| 함수명 | 파라미터 | 반환값 | 설명 |
|--------|---------|--------|------|
| `getAttendanceByPeriod` | year, month?, classId? | 출석 레코드[] | 기간별 출석 조회 |
| `getTalentHistoryByPeriod` | year, month?, classId?, studentId? | 달란트 레코드[] | 기간별 달란트 조회 |

### 3.3 UI 컴포넌트 (settings/page.tsx)

- 기존 settings/page.tsx에 `'export'` 탭 추가
- 필터 컨트롤 컴포넌트 (인라인, 별도 파일 불필요)
- 미리보기 테이블 (반응형, 인쇄 최적화)
- 인쇄 버튼 (`window.print()`) + CSV 다운로드 버튼

### 3.4 인쇄 스타일

- `@media print` CSS (globals.css에 추가)
- 인쇄 시 헤더/사이드바 숨김
- 인쇄 시 테이블만 전체 화면 표시

---

## 4. 구현 우선순위

| 우선순위 | 기능 | 이유 |
|----------|------|------|
| P0 | 출석부 월별 조회 API + UI | 가장 빈번한 사용 |
| P0 | 달란트 내역 월별 조회 API + UI | 가장 빈번한 사용 |
| P1 | 연별 조회 | 연간 보고서용 |
| P1 | 인쇄 기능 (`window.print()`) | 핵심 출력 기능 |
| P2 | CSV 다운로드 | 편의 기능 |

---

## 5. 비기능 요구사항

| 항목 | 요구사항 |
|------|---------|
| 권한 | admin/teacher만 접근 (parent는 제외) |
| 성능 | 월별 데이터 조회 2초 이내 |
| 인쇄 | A4 기준 가독성 확보 |
| 보안 | 세션 인증 필수, 타인 데이터 조회 불가 |

---

## 6. 구현 범위 (Out of Scope)

- PDF 파일 직접 생성 (라이브러리 추가 없이 브라우저 인쇄로 대체)
- 엑셀(.xlsx) 형식 (CSV로 대체)
- 이메일 자동 전송
- 대시보드에서 바로 출력 (설정 메뉴에서만 제공)

---

## 7. 예상 파일 변경 목록

| 파일 | 변경 유형 | 설명 |
|------|-----------|------|
| `src/lib/db.ts` | 수정 | `getAttendanceByPeriod`, `getTalentHistoryByPeriod` 함수 추가 |
| `src/app/api/export/attendance/route.ts` | 신규 | 출석 데이터 export API |
| `src/app/api/export/talent/route.ts` | 신규 | 달란트 데이터 export API |
| `src/app/(dashboard)/settings/page.tsx` | 수정 | 출력 탭 및 UI 추가 |
| `src/app/globals.css` | 수정 | `@media print` 스타일 추가 |

---

## 8. 수용 기준 (Acceptance Criteria)

- [ ] 설정 메뉴에 "출력" 탭이 표시된다
- [ ] 연도/월/반 필터를 선택할 수 있다
- [ ] 출석부 미리보기 테이블이 정확한 데이터를 표시한다
- [ ] 달란트 내역 미리보기 테이블이 정확한 데이터를 표시한다
- [ ] 인쇄 버튼 클릭 시 브라우저 인쇄 다이얼로그가 열린다
- [ ] 인쇄 시 헤더/사이드바가 숨겨지고 테이블만 출력된다
- [ ] CSV 다운로드 버튼이 올바른 파일을 다운로드한다
- [ ] parent 역할은 설정 메뉴에 접근할 수 없다 (기존 보안 유지)

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 1.0 | 2026-02-18 | Initial plan | Claude (pdca planner) |
