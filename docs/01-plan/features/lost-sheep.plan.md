# 잃은 양 찾기: 미로 탈출 (The Lost Sheep) Plan

> **Feature**: lost-sheep
> **Date**: 2026-02-18
> **Status**: Draft
> **Priority**: Medium

---

## 1. Overview

### 1.1 Background
동은교회 초등부 게임 메뉴에 5번째 게임을 추가합니다. 기존 벽돌깨기(성경퀴즈), 노아의 방주(테트리스), 다윗의 물맷돌(슈팅), 오병이어(서빙)에 이어, 누가복음 15:3-7의 잃은 양 비유를 기반으로 한 미로 탈출 퍼즐 어드벤처 게임을 제공합니다. 목자가 되어 99마리 양을 우리에 두고, 험난한 지형 속에서 길을 잃은 1마리를 구출해 돌아오는 감동적인 게임입니다.

### 1.2 Goal
플레이어가 목자 캐릭터를 조작하여 미로를 탐색하고, 늑대(적)를 피하며, 좁은 절벽 길을 통과하여 잃어버린 양을 찾는 퍼즐 어드벤처를 구현합니다. 양을 찾은 뒤 어깨에 메고 돌아오는 감동적인 귀환 연출까지 완성합니다.

### 1.3 Target Users
- **학생**: 게임 플레이 및 달란트 보상 획득
- **교사/관리자**: 학생에게 달란트 보상 지급

---

## 2. Requirements

### 2.1 Functional Requirements

#### FR-01: 미로 탐색 핵심 메커니즘
- 목자 캐릭터를 터치/스와이프로 상하좌우 이동 조작
- 모바일: 화면 하단 방향 버튼 (↑↓←→) + 스와이프 지원
- 스테이지별로 미리 정의된 미로 맵 (타일 기반 그리드)
- 미로에는 벽, 길, 절벽(좁은 통로), 풀숲(시야 제한) 등 지형 요소
- 목자의 이동은 부드러운 타일-투-타일 애니메이션
- 미니맵 표시 (우상단, 탐색한 영역만 표시)

#### FR-02: 늑대 (적) 시스템
- 늑대가 미로 안을 순찰하며 일정 패턴으로 이동
- 늑대의 시야 범위(붉은 영역)가 표시됨
- 목자가 늑대 시야에 들어가면 추격 시작 (속도 증가)
- 늑대에 잡히면 생명력 -1, 가장 최근 체크포인트로 리스폰
- 목자의 지팡이 사용: 지팡이로 늑대를 1회 밀쳐낼 수 있음 (쿨다운 10초)
- 스테이지가 올라갈수록 늑대 수 증가 (1마리 → 2마리 → 3마리)

#### FR-03: 지형 장애물 & 퍼즐 요소
- **절벽 길**: 좁은 1칸 통로, 정확한 타이밍에 통과해야 함 (바람이 주기적으로 붐)
- **풀숲**: 목자가 들어가면 시야가 좁아짐 (주변 3x3만 보임), 대신 늑대에게 안 보임
- **바위 밀기**: 특정 바위를 밀어서 길을 만들거나 늑대 통로를 막음
- **샘물(체크포인트)**: 도달하면 체크포인트 저장 + 생명력 회복
- **별(수집 아이템)**: 미로 곳곳에 숨겨진 별 수집 → 보너스 점수

#### FR-04: 양 구출 & 감동 귀환 연출
- 미로 끝에서 떨고 있는 양 발견 → 양에게 다가가면 "양 발견" 이벤트
- 양 발견 시: 목자가 양을 어깨에 메는 감동 애니메이션 (2~3초)
- 배경음악이 감동적 멜로디로 전환
- 양을 메고 돌아오는 길: 미로가 밝아지고, 늑대가 물러남
- 출발점(양 우리)에 도착하면 99마리 양이 기다리는 장면
- "하늘에서는 죄인 한 사람이 회개하면 더 기뻐하시느니라" (눅 15:7) 말씀 표시
- 축하 파티클 이펙트 + 클리어 사운드

#### FR-05: 스테이지 시스템 (5단계)
- **스테이지 1: 초원 미로** — 단순한 미로, 늑대 없음, 튜토리얼 (이동 방법 안내)
- **스테이지 2: 숲속 미로** — 풀숲 지형 추가, 늑대 1마리 순찰
- **스테이지 3: 절벽 미로** — 절벽 길 + 바위 밀기 퍼즐, 늑대 2마리
- **스테이지 4: 어둠의 골짜기** — 시야 제한(횃불 주변만 밝음), 늑대 2마리 + 빠른 속도
- **스테이지 5: 험난한 광야** — 모든 요소 종합, 늑대 3마리, 복합 퍼즐, 최종 보스급 난이도
- 각 스테이지 제한시간: 60초(쉬움) ~ 120초(어려움)
- 스테이지 클리어 조건: 양을 찾아서 출발점까지 귀환

#### FR-06: 성경 말씀 & 퀴즈
- 각 스테이지 클리어 시 잃은 양 비유 관련 성경 말씀 표시
- 스테이지 3, 5 클리어 시 퀴즈 1문제 (예수님의 비유/양 관련)
- 퀴즈 정답 시 보너스 시간 추가 + 생명력 회복

#### FR-07: 달란트 보상
- 기존 게임과 동일한 보상 API 패턴 (`/api/games/lost-sheep/reward`)
- 스테이지 1 클리어: +1 달란트
- 스테이지 3 클리어: +2 추가
- 스테이지 5 클리어: +2 추가 (전체 최대 5)
- 퀴즈 전부 정답: +2 보너스
- 하루 3회 제한
- 교사/관리자만 보상 지급 가능

#### FR-08: 게임 UI/UX
- Canvas 기반 렌더링 (기존 게임 패턴 동일)
- 모바일 세로 화면 최적화 (400 x 700px)
- 게임 시작 전 학생 선택 (보상용)
- HUD: 생명력(❤️), 남은 시간, 별 수집 현황, 지팡이 쿨다운, 미니맵
- 스테이지 클리어 모달, 퀴즈 모달, 게임오버 모달
- 효과음: 이동, 늑대 조우, 지팡이 사용, 양 발견, 귀환 멜로디 등

---

## 3. Game Design

### 3.1 화면 레이아웃

```
┌──────────────────────────────────┐
│  ❤️❤️❤️  ⏱️ 45s  ⭐3/5  Stage 2 │  ← HUD
│  지팡이: [████░░] 준비됨         │
│  ┌────────┐                      │
│  │ 미니맵 │                      │
│  └────────┘                      │
│                                  │
│  ██░░██░░░░██░░░░██              │
│  ░░░░██░░██░░░░░░░░              │  ← 미로 영역
│  ██░░░░🐺░░██░░██░░              │    (스크롤)
│  ░░██░░░░░░░░░░██░░              │
│  ░░░░██░░🧑‍🌾░░░░░░██              │  ← 목자
│  ██░░░░░░░░██░░░░░░              │
│  ░░░░██░░░░░░░░🐑░░              │  ← 잃은 양
│                                  │
│      ┌───┐                       │
│      │ ↑ │                       │
│  ┌───┼───┼───┐                   │  ← 방향 버튼
│  │ ← │   │ → │                   │
│  └───┼───┼───┘                   │
│      │ ↓ │                       │
│      └───┘      [🪄 지팡이]      │
└──────────────────────────────────┘
```

### 3.2 미로 구조 (타일 기반)

```
타일 타입:
- WALL (██): 통과 불가
- PATH (░░): 이동 가능
- CLIFF (⚠️): 좁은 절벽 길 (바람 타이밍)
- BUSH (🌿): 풀숲 (시야 제한, 은신 가능)
- ROCK (🪨): 밀 수 있는 바위
- WATER (💧): 샘물 (체크포인트)
- STAR (⭐): 수집 아이템
- SHEEP (🐑): 잃은 양 위치
- PEN (🏠): 양 우리 (출발/도착점)

그리드 크기: 15x20 (스테이지별 상이)
한 타일 = 28px (Canvas 400px 기준, 약 14타일 가로 표시)
카메라: 목자 중심 스크롤
```

### 3.3 늑대 AI

```
순찰 모드:
- 미리 정의된 경로를 반복 이동
- 시야 범위: 전방 3칸 (부채꼴)
- 이동 속도: 목자의 0.8배

추격 모드:
- 목자를 발견하면 추격 시작 (붉은 !)
- 이동 속도: 목자의 1.3배
- 5초간 추격 후 포기하고 순찰 복귀
- 벽 뒤로 숨으면 시야에서 벗어남

귀환 페이즈 (양 구출 후):
- 늑대가 서서히 후퇴
- 추격하지 않음
```

### 3.4 양 구출 귀환 연출

```
1. 양에게 도달 → 화면 줌인 + 빛나는 이펙트
2. 목자가 양을 들어올려 어깨에 메는 애니메이션 (3프레임)
3. 감동 멜로디 시작 (Web Audio 합성)
4. 미로 전체가 밝아지는 트랜지션
5. 귀환 경로: 최단 경로 가이드 라인 표시 (점선)
6. 양 우리 도착 → 99마리 양이 메~ 울며 환영
7. "기뻐하라 나와 함께..." 성경 말씀 표시
8. 스테이지 클리어 처리
```

---

## 4. Technical Considerations

### 4.1 파일 구조 (기존 패턴)
```
src/app/(dashboard)/games/lost-sheep/
  ├── page.tsx                        # 서버 컴포넌트 (학생 로드)
  ├── _lib/
  │   ├── types.ts                    # 타입 정의 (GameState, Wolf, Tile, etc.)
  │   ├── stages.ts                   # 스테이지/미로 맵 데이터 (5단계)
  │   ├── mazeGenerator.ts            # 미로 맵 정의 및 유틸리티
  │   ├── quizData.ts                 # 퀴즈 데이터 (잃은 양/비유 관련)
  │   ├── gameEngine.ts               # 게임 로직 (이동, 충돌, 늑대AI, 퍼즐)
  │   └── renderer.ts                 # Canvas 렌더링 (미로, 캐릭터, 이펙트)
  ├── _components/
  │   ├── LostSheepWrapper.tsx        # 클라이언트 래퍼 (학생 선택)
  │   ├── LostSheepGame.tsx           # 메인 게임 컴포넌트
  │   ├── QuizModal.tsx               # 퀴즈 모달
  │   ├── StageClearModal.tsx         # 스테이지 클리어 모달
  │   └── GameOverModal.tsx           # 게임오버 모달

src/app/api/games/lost-sheep/
  └── reward/route.ts                 # 달란트 보상 API
```

### 4.2 Canvas 렌더링
- requestAnimationFrame 기반 60fps 게임 루프
- 타일 기반 미로 렌더링 (28x28px 타일)
- 카메라 시스템: 목자 중심으로 뷰포트 스크롤
- 늑대 시야 범위: 반투명 빨간색 오버레이
- 어둠 스테이지: 원형 마스크 (횃불 범위만 밝게)
- 양 구출 이펙트: 파티클 시스템 + 줌 애니메이션

### 4.3 모바일 최적화
- 터치 방향 버튼: 하단 D-패드 (최소 48px 버튼)
- 스와이프 제스처: 손가락 드래그 방향으로 이동
- 지팡이 버튼: 우측 하단 독립 버튼
- 세로 화면 고정 (400 x 700px 기준)
- 미로가 클 경우 카메라 스크롤로 처리

### 4.4 보상 API
- 기존 five-loaves reward API 패턴 동일
- 교사/관리자 인증, 학생 확인, 일일 제한(3회), 트랜잭션
- 별 수집 보너스는 점수에 반영 (별도 달란트 X)

### 4.5 효과음 (soundEngine 확장)
- 이동: 가벼운 발걸음 효과 (잔디)
- 늑대 조우: 긴장감 있는 경고음
- 늑대 추격: 심장박동 같은 빠른 비트
- 지팡이 사용: "휙" 바람 소리
- 양 발견: 감동적 종 소리 + "메~" 효과
- 귀환 배경: 따뜻한 합성 멜로디 루프
- 양 우리 도착: 축하 팡파레
- 기존 공통 사운드 (퀴즈, 스테이지 클리어, 게임오버) 재사용

### 4.6 미로 맵 데이터
- 각 스테이지의 미로는 2D 배열로 하드코딩 (`stages.ts`)
- 랜덤 생성 대신 수동 설계로 난이도와 재미를 보장
- 늑대 순찰 경로도 맵 데이터에 포함
- 별, 샘물, 퍼즐 요소 위치도 맵에 정의

---

## 5. Implementation Order

1. 타입 정의 (`types.ts`) — GameState, TileType, Wolf, MazeMap 등
2. 미로 맵 데이터 + 스테이지 설정 (`stages.ts`, `mazeGenerator.ts`)
3. 퀴즈 데이터 (`quizData.ts`) — 잃은 양/비유 관련 퀴즈
4. 게임 엔진 (`gameEngine.ts`) — 이동, 충돌, 늑대 AI, 지팡이, 체크포인트, 양 구출
5. Canvas 렌더러 (`renderer.ts`) — 미로 타일, 캐릭터, 늑대, 이펙트, 카메라
6. 메인 게임 컴포넌트 (`LostSheepGame.tsx`) — 게임 루프, 입력 처리, 상태 관리
7. 모달 컴포넌트 (`QuizModal`, `StageClearModal`, `GameOverModal`)
8. 래퍼 + 서버 페이지 (`LostSheepWrapper.tsx`, `page.tsx`)
9. 보상 API (`/api/games/lost-sheep/reward/route.ts`)
10. 효과음 추가 (`soundEngine` 확장)
11. 게임 목록 페이지 업데이트 (`games/page.tsx`)

---

## 6. Out of Scope

- 랜덤 미로 생성 (수동 설계된 미로만 사용)
- 멀티플레이어
- 목자 커스텀 스킨/의상
- 랭킹 시스템 (향후 추가 가능)
- 가로 모드 지원
- 미로 에디터

---

## Version History

| Version | Date | Changes | Author |
|---------|------|---------|--------|
| 0.1 | 2026-02-18 | Initial draft | AI Assistant |
